import bz2
import TenhouDecoder


def extract_bz2(hex_str: str):
    if hex_str.startswith("0x"):
        hex_str = hex_str[2:]

    compressed = bytes.fromhex(hex_str)
    decompressed = bz2.decompress(compressed).decode()

    return TenhouDecoder.GameData(decompressed)


class DiscardedTile(TenhouDecoder.JsonSerializable):
    def __init__(self, tile: TenhouDecoder.Tile, discard_type: int):
        self.tile = tile
        self.discard_type = discard_type  # 0 = tedashi, 1 = tsumogiri


class Meld(TenhouDecoder.JsonSerializable):
    def __init__(self, tiles: list[TenhouDecoder.Tile]):
        self.tiles = tiles


class PlayerState(TenhouDecoder.JsonSerializable):
    def __init__(self, starting_hand: list[TenhouDecoder.Tile], is_oya: bool, global_score: int):
        self.closed_hand = sorted(starting_hand)
        self.melds: list[Meld] = []

        self.is_rii = False
        self.discard_pool: list[DiscardedTile] = []
        self.hand_is_open = False

        self.is_oya = is_oya
        self.global_score = global_score

    def draw_tile(self, tile: TenhouDecoder.Tile):
        self.closed_hand.append(tile)

    def discard_tile(self, tile: TenhouDecoder.Tile):
        # Tile should always be in current hand
        idx = self.closed_hand.index(tile)
        self.closed_hand.pop(idx)
        self.discard_pool.append(DiscardedTile(tile, int(idx == len(self.closed_hand))))
        self.closed_hand.sort()

    def riichi(self):
        self.is_rii = True

    def call(self, meld: TenhouDecoder.ChiiMeld | TenhouDecoder.PonMeld | TenhouDecoder.KanMeld):
        removed_tiles = 0
        for i in meld.tiles:
            if i in self.closed_hand:
                self.closed_hand.remove(i)
                removed_tiles += 1

        match meld.call_type:
            case "chi":
                assert removed_tiles == 2
                self.melds.append(Meld(meld.tiles))
                self.hand_is_open = True
            case "pon":
                assert removed_tiles == 2
                self.melds.append(Meld(meld.tiles))
                self.hand_is_open = True
            case "shouminkan":
                assert removed_tiles == 1
                # Find the pon
                for i in range(len(self.melds)):
                    if self.melds[i].tiles[0].tile == meld.tiles[0].tile_num:
                        self.melds[i] = Meld(meld.tiles)
                        break
                else:
                    raise Exception("Could not find shouminkan call group")
                self.hand_is_open = True
            case "daiminkan":
                assert removed_tiles == 3
                self.melds.append(Meld(meld.tiles))
                self.hand_is_open = True
            case "ankan":
                assert removed_tiles == 4
                self.melds.append(Meld(meld.tiles))


class RoundState(TenhouDecoder.JsonSerializable):
    def __init__(self, round_data: TenhouDecoder.Round, global_scores: list[int]):
        self.round_no = round_data.round_no.round_no
        self.honba_count = round_data.honba_count
        self.rii_sticks = round_data.rii_sticks

        self.tiles_left = 70
        self.dora_indicators = []

        self.players = [PlayerState(round_data.starting_hands[i], i == round_data.oya, global_scores[i]) for i in
                        range(4)]

    def draw_tile(self, ev: TenhouDecoder.DrawTileEvent):
        self.players[ev.player].draw_tile(ev.tile)
        self.tiles_left -= 1

    def discard_tile(self, ev: TenhouDecoder.DiscardTileEvent):
        self.players[ev.player].discard_tile(ev.tile)

    def riichi(self, ev: TenhouDecoder.DiscardTileEvent):
        self.players[ev.player].riichi()

    def dora(self, ev: TenhouDecoder.DiscardTileEvent):
        # TODO - make this just get the dora instead
        self.dora_indicators.append(ev.tile)

    def call(self, ev: TenhouDecoder.CallTileEvent):
        self.players[ev.player].call(ev.meld)


class GameState:
    def __init__(self, data: TenhouDecoder.GameData):
        self.data = data
        self.rounds = data.rounds
        self.current_round: RoundState | None = None

        # Everyone starts off with 25k
        self.scores = [250 for _ in range(4)]

        self.round_no = -1
        self.event_no = 0

    def next_round(self):
        if self.current_round is not None:
            self.scores = [self.rounds[self.round_no].score_changes[i] + j for i, j in enumerate(self.scores)]

        self.round_no += 1
        if self.round_no > len(self.data.rounds):
            self.current_round = None
            return

        self.current_round = RoundState(self.data.rounds[self.round_no], self.scores)
        self.event_no = 0

    def get_next_event(self):
        if self.current_round is None or self.event_no >= len(self.rounds[self.round_no].events):
            return None
        return self.rounds[self.round_no].events[self.event_no]

    def process_event(self):
        ev = self.get_next_event()
        if ev is not None:
            match type(ev):
                case TenhouDecoder.CallTileEvent:
                    self.current_round.call(ev)
                case TenhouDecoder.DoraIndicatorEvent:
                    self.current_round.dora(ev)
                case TenhouDecoder.DrawTileEvent:
                    self.current_round.draw_tile(ev)
                case TenhouDecoder.DiscardTileEvent:
                    self.current_round.discard_tile(ev)
                case TenhouDecoder.RiichiEvent:
                    self.current_round.riichi(ev)
                case _:
                    raise Exception(f"Event {ev.event_name} is not handled")

        self.event_no += 1

    def dump(self, readable=False):
        if self.current_round is not None:
            return self.current_round.serialize(readable=readable)
        return None


if __name__ == "__main__":
    import json

    h = "425A68393141592653599B7A5FD600173D9F80520FFFE73FFFFFF03FFFFFF0601F7F3C1663CA8AA551E869400502BBD813583B493E98CAFBEF838F52F7BBC27AF3DE1C73B831B0E73BDE3DEAF7BC5E76E3BC7B79EDC2BCB400055283401A0000022200264D3132600134C8C4C431188D4D4D14D04A2418D0840D26A693F4D4DA46694FD1A146F51A8D1ED126861A0998A554340000000000000006A7934092526946D47B5478A66994D9A14FCA8F51A0F50000129EA421927A4A4F4FD5434D001A69B29EA01EA03400012240235014C9A6A9B6A9E31346A9E047A4F54F26A7B2A7A801A04741DAC63140080EA6949A05DA85D1000BD7F785549748428140A08431902811BF8F939B91BF2BE76E8E6C9CE04C150BE760DF07B9C7F26FD582CC20B8EB1B848C8504282C84E0A2D777B6F0CF75628432563578EDC083375469BB9A520120DA86F49710E110D093C4D02D0479AE95524EA43A548F24EB8819F8C403442091441E200C9A3CEF53A6C3ED6E2751919107B2E2328AD46AF63695F3470FD5C0401B257D71AAF65233AC499530E0B534004826CEAD674E9CDB6D713E9A0224E2011190320C2185112BDF52DA98D5B9E99E2FFF591E5D732DDB47FBFA39B17FB72BC8EEDBED27D1B3CE2BF7F712B3FF4FBD699C567FEFFD466689A3102029202968A32719648CD208240A2279B53C01BBAA9BB0AE085C079EEB51A2A118E5A5824856C220F384EEDB5B71CC35A2376B8D8A35724E173934EB728D04EB4C5C6D638A8DC1AAF198415D0599505D97B16D09C1A55ABBB5B439696ED8A4D6EDECE25C5BC17566E4CADA3A691964658520DBABAC664962B726F54BDBBE731DE3D1029C3579A71A833783466513254CA75231C20E70E46956B0C8CE35C2922A6A676E8CF18BE24346CC8DC969DD25754E1EC8856CDC9A3A6C8AE02159C9876970DDBBDB56EF02C818A41135671ED115C0EA6E5502155B0812410D2715331CE1E6962AE721B98BC17999B34F317161BE6BD44E6918261481A266242922973973079442935A3019209B6EA2EF641CCAB99572DE6D24950A4AE734D15417354ADA182D145DDA7786A673773584EAF756C9D9E315B2CB636D4ECE410A1DCA294C658D919CAB40BDD7132239934D804C5C5D1B3431CCBA1AF97394AAED5641C5532A32EF2B6539D47973B3C2745D12E81AD5689DB20D3E6AB79B1619A537526041AA810D6E38A34AE662CD61C199756891C5CAE3CB0EEDE50BDBA712F392CE1ADD69D0C247282334C8A2E8A877BB352C8C8BC7510CDA61402620EC5441E42AB246655BADAA875545B26A9564637A52DBDDA782641D8A175389976F15E52F8F3FBB8072FCF9FB1E79B4D2FC7F8FD87F4FFBFEDCFC2CE7F9737D2E49533BAFC95BB4543BCA0F2CCCBA6B7D7554D8556C89121AB6583C674F45EF15F6AEF0EDDB8B98C63BDA834F0BC662028CB0423DE8DC921D66F7BD85BD8D973DC8E9C1B6FA23B08C8F3C14D57942F09452054C9AE961B5DF0BEE8CECBB19B5D8EB0E9672A67A27779D17A7A077ACA8C6C6BA39C78D28628E53EE4EEF7071A52BB7CAE66E3A0E10EB1815D94699ABE6AC555562C5E0D11B3581DD8E88E8F1F84575402AA4B89ACD8EB5E05BE492231795D65E5793E546578B731CC761919BB51D8C1D1B332F12AE548BBA4D845F6C9E9A6E48B4FB3CDBC192F3A4EDA80F03A891408ADC89AB3C6FBB3DE351BAD276768408676FB3D896352D77A9D627543BDD3312F84DDC45062A4A62EC91B148DC8A0A75D88A171578D65F145D821726F240D9DC6AB3CADC489651BA59D9D145281D56335F656D9F3A20E92F1AED8C9F17922089A8AC6E3991E2DED958B46AF205BAC120726DDEE3CEDF6EFCA538208887BA19337A6D355746166B06F695DD1AAA1AEB14A9136B744D7978491B7A8EF564336DDDE2C8A6A22CEB50BB079DED046FAB66633367B4F26C9111052D98802A6EEB18AAB39B819BA461BCE9BE8506A6609C8DB75DD99B52B5D151AFA63ABAA56CA8AAC955717BBD1DEE599DC4660AA82F518D11161EF66294D2B48F0F01E337CEDF3B856D1D5B372D3C72DB95839AAAA9A5254F66C45C28A3283A8A717A2B146608782F39319DB779035742D8D89768D4CC4445E559BCAC96EA36819C2BBB4E14CE675BC696764888E9AD5DDAA138154348B73B1DEC3DB065C29A8267684A3CB938E966D15139DA42A9377395931B3B055022E29F68385951922654551A812604C49B4B4A81319DDD90C3B9EDD9577D9EDB8373470C25BB2D5F59B088B5B73DB6324E23BCABD5598D6D4F5D4D166CCABBD68D0B36AAE744EE06664EDD9644CA189598A7F27EDF6FEB8F77D1EDF9BE3F2F0F3CD35EBE4AD7445FFA6FC89B8BDB6D375057B96F71C44C02090044C8390A00284214463529B4718145DF3FBBD1ADCD2D165A89E110D1590481CB4ABCD324FD538EFA428E3EABADB91710E6FA80D98EE73E455E76D79D2261AE59E0C630823C9919812205D4084BC8131A497B70A0EE0EBA25E06C58FD94988304D60891F789EF6D4779D1BBD06CD86083CEFD159DCFD1E77C13D5DA9F02BD4BFDB91702FC8868ECBB19B0316535771933FB1F91185898A910FB18BBEFBEF9D78456412274F7FBD2EFDD22E321B143CF173A29661E32034096B9CE330CCB7694DD11034DA52841C1A47C75BE9DF98AAC3407FAFFD0733BB12D91B3A3E7B2A84683101ADA120911031B620FDAAC442117C7FECB3F8DE682EC3EDB92FF4AFF6B956B73EF37F90434EC8E04A1C36A26A3FF219AB143EE87F317EA2F5FB7B2D5AC315452A76BBB874282E320821DE610023BF57DB71D5DEAE66C8C213B53C0C843CAB89E88DF04D82AF458C8597711133D5E90557672C3D11AD5F38F6E9C054C4D67156493C1D219E0CEE54743D941DC03902D4E057B15DB511F9BD9078B04677F5CF76A3D6AE41E47E7DB067F3BC31F23F4C3EA8E6558AEAA0D6BA12FD5EEE56DE50C506696469116FE6553312BB593F3F6AFBE165B6E4CDBA1BDA79AA663BEE6BD9E60CFF0DF9153E4C11319C492E2C3B9B1F168289529E4AAE62DA96D1A762A57898218E0366606E031A403E198D037A42E86C21016601999D91AC36D861A730C070D201040C12010D2501205CB97BDCB975734393267212648634672654922612525934CA1EAAA95CA4E99202A5515BABDCB85EE5EE2D59831750A1040A9809424120103105DE409E4473809D00820101A6C3701B0C3730C30D2850888D1BC03903D3F06F474ECA48CAB56283CE691B89B89C713065330DC30C6D160C8B10E180DF820C183105250A14284A02241049F114C890D2CD4150B510D21BB1A0681A3742481301C920836C5D582EEF757BDCB154615A85160AEFB661C31B5AC1036B51DDA0A8E6135AA9D163122B7686E5A9AA8B16228899752A2BD114284CA1302F80A2A142C15030AF6B615ADCBBB6E994CA24D268205C3331842E96D193864A1332C8711C471471384C223C0EDD144DFCFE9B5518B322B09D3A13D132690936152C98FA644893710444356659D868D8EEC353538A1345494569F749B8C5F13D460BA5E2E492C4ABC716ABDCD0AC82A60A103061C69EEFDBDDE1E0227AF0FAE9A7467FDFADFB3B7749F1F4B759BC593E441D49B40E5E7B1954C4FA67C3FAFD23B3BEBE30D77C5AC57785EF736BB053D67F87C473E57C96F83E8A089001DFB7F4FDCE45C75020DEC6BB44199A5D7D5F61B008CDE4CCC859B5302FA7F9BCD19794F2671CC103AEF9AF179E40F26568DF0D86555F9DCB3E77FAE07A8F5FBF7D80CF823A12B1183CF64A58FF72593E43AB8F7CA90D764E461AE50FAF9EAB55A9F56C5CCE491447EF0C38896E491311A7DB12D69992CB99D5AE6762DE134CCE26D5AD7C38A135FB7934E748A3324B42669272C7273CD3C6C6EA9E3B848DDCC84B491CCC493898712185DF9A446E2A6D78457AD0A23D58951D64C0E130984E11B0E0F3846DD672D904049C12853CCDEB0B5618C43FA5C58115915858C9B12BB3194BA3725350D9DF9B50AC9221907ABD58CD759536908D5974618D872B213526D15D21E8431AC3C3C3C17030C63435EA9A37CD434F535866B08C43D50B9A91E2EC8A94155361D915EA49D5C3813AEFBFFD2B12B51C5D754A2A4C98E9ACC549AA4E2872A71113FEABCBD7BFD3E9C37F666FF63D5646CA3656B7991595BF9663ECCDCC86D3AA4039074984048D31965C6412001D06236D29D0FCFBF9C530FB72570B43D72F96C8A6CD764FE4CCDA9BAB4913AB739DED4B725D779345A86B9E5766BBB08DD0C0E3ADF9E23044F4C95A4240E42343F1838B44EE0881398BE1D614C05E9F6F37B19D0E90C1DCBCA15CFCA2346771E51C07F2393E391F376EA838C2A2B7D29FD595E9D7A12E28DE757E4F461EFA36EE5DBA91D8F85F3F847EAE0DB8820F2124B836D7037C2A09157E6D9FD68A6D37464035CADB19EC80C3308BD55FDF4090F29971A57076A286DA6AC960F5E4CABAA6A1A9EAB97B2D10CC8EB838AC6EC6E3657536C2CB4D870D202110B49061E01E04D63106259C018528C6D4224313CD623289198C30C30D0399625C8E739115292930C3317698C959A88C0DB78089D12F2FF71E7FEE764F857FAF76BE3C25DF9FBF777ECFD153F38D7B7B7F09BB2CF37703BAD50D8454D02C32CB2EA1E43BA93800B181B480D028D280A441E9FBB7CFE8E646D7354477BC2476664E98DD695F41EE19E8BF0C6099562E8E54B5B10E8355E070B0B4693FBE875EE117BB36A3D7C602B10209F21EA53DCFBCDE0B0D0C906BA4479E0F86D1ACA5EADC51AC9980C384AD46BBB4D9B4EA196A4C0455D072BBA92D6C4E4E87CA2649D9BDE6F5F74D10C633D5C78F13884F35DE6EDBB9CC3BDE5AECC8634198E350B32DB6FB4DA6965F7BA58BABDEC6AEA2D0A5298381ECEAC985A8616367EDB0EBB5F30360DA5CD0842D7BCCA284125285F04B60AE532AA42646336991D250F25CF3B15CA1399398E948BE29F7CBBEBC61E336D8725ECF69FA7CFFAFE71F4F6E5FC79D3562FD4C3E941D8D4CEDFFE6CBCDBD9890E6F4D257AACA956BED47BB9A9D66EB656048CB2863206E0277F1ACFC3F087E7C2E3BE7633A7B775067BEBCA09BA6EA22BD39F3611E50D8E78202E583979BD8CD56D19A343628BB68378FCF156D0AEEA5C66868A416404433DF2A3D94FA44532474D727855A2ED1792E8F2EE669A0E48352BBD56464C9E61A840DD73DD152E0A96177B8FEBB77151797879F86D18FDA40F69E70F3E9E7CBEEF6A4679722E5A489212244B2528EE99BB8C44482401F657454462DC5F28618175F06024A924A868B2CD86E0A1148242D866B0062EB6EA59874D45D5A51CE491441992958B4C1A011B8666C0B8CF288CA118C129148F381A2BF3D5F9DE5A127EFE51CB220BE2D6F2A62099989A8EE7E739C637412307E32C9486F51BFAE3DE53FB7EC02FD48F507D6AABD1DC53B9D7E9A49DC79B111519B21DA06FC0C9A9881E76B4B731587A2EB6E7D2C1A155B22BBE351F67ADB3547049AC4C51345C03ABD4B92E67676162A841A85373DD777F4C68D862AEAC1D298B4A30175344F4C51DF482F2BE3B2FFCF72DED1BCF59E5E1E81E327EB78373136A18CD1AC18BF6588B1563B30D572E31658DFBAEB0D18BDCDB8DA73D8550B2B0D066E7C0788A2C9ED7C74E5C90021952EC1861AEFBEF6098A892885C3246C42C9932768A96D7A996104AC80CCC8CC7676D5EDAB4578EB66EDBA78708CFB09A3423A47607A8E86FF83E14C85592EFEB17EB258D44C80AC6E070024B2FA67E0EEEF6FB37F52767B7A0E732EB4D4DB5DAD7CCCEDA83574AC695D166C5D76F70B8B762F0746D0A1B151AA4332CEF9DF1BD1D17C7E41135F855C460EC04BC8C8B4A09EB6CFA2A4B05898BF78B715DB76CBD7621F970D4051D9462B22E1670C9B677E7C0FB522B2D2193BD627BAD6A525419DA4A1E95AEB6D3D7BCDE7F4E01CA767138704C97B3B239549489489048924B87036EE9A172942939934993D37C51B460DC5EEAF75BEC2F367215BA4ECBEDCC73F0D05B0C6160C1E6FAFAA0172971189830DCE68202A2842844896D819AC2C4B062274F41C023903CD0D80709EE25738CBEBFCC06CD0366609BBA23E34C3BA1C95B6B23CD0D702634CDF5BE6F27A3C477F93CD82D6694A47C714B3CBA73DB3F0DEB69BE8E8E266D6A1DD8B406B178E85551BC5E549E8AEF23107987263CB3D1ADF4D9E3D714B5EE60A4BA3341FB344F6BBF33BF242228E9AF36CE4FDE5DE4B624ED972F07DFE76AC62AEC47B0C8EF552CCDAAD9C86E952D356D5D2BA16D745D1FDBA8A079E3A9D7AF96C76EFDDBD411A7326318C76F1E1ADC5CA6DAF21B695068AD4AE3DA5046CAECD86DA013C5317A15D212AD55D579F9B7DA2205ADACADC9D7F0B2096EBEFD0A253266C3550229F9CDB3932E9CA81F87A1F3E1AA75FE796A3B9EA2757611EEB813F173A5740A798C97792756D6A4E93E6F45296F0E7D3DF6D50DBE2CD9BDAA4E6DDF36E36B1B13A459B5AD2F931C9D5A1204610E259C35F26E37501EAE659B636AB70180EC7BFBDCEF6AAE1F77DF980CDBB1E277EF0AFCC3E86A5153F71F199A0CFD3D0A237D42C38EC4FB0ED6B7F89BB7ECD9E11912231A179375A444A277BFB696AA9EFE12671885EE27E4E1BF5DDDDF1CE8983588A684D12563DDE700BEF618842D30B12C9487999E8C2A3DEF1E64866810F5592A144890D1B36E23C47DF7912F6BF2266F0C709A2A8AA9122F8917605A850A3ED32F35AAB254145557A3D87B43B7ECE9EBB395353F47F9D7E8ABF1E3EAEC9EFDDD72B0FF094BDB25EDFDEC5D1AD2958DFFC210804201081276CDA81C2FA218843F3B5B9837E33509A4BCA04E41F954C621CE7A14A29E855D2A33A4F962AC7A7B2BACFBB232626726E0C17C814CD35BFD79AF18DD1A710F1C6968D0874995451495AF066182325F422D9D5689074D24EB8AAB8254C01EC3A79582E044A42A204865D2CE52832AC5544D4487523EB6EF108017C1A42108D34C79CC537724209B2B1792AA2900009CCFEB357F80412D8BFF60F766ADF80101725912D97783E111AF9FEF4FF1F29751BABAE47BBEE5E241DBCCAF7325391975A6B2B7BD766F6D73ADBECEB428911A3F53B2860DDDCB33E93B4B2FA65B17EDBA9DA91149BC2C5A9B9ABD8394D9FEFC51CF8A80005BABFEBFAA9A6E3FA7ED62A579AD35053FD254B6FBC0C7968F8C6A75A33D001D5881080041857025F36927FDE015BED08F33497A3E30016F3FA2485A741F2F6EBD9E9FD3614FD7EC9BF153A18A9C1FEB26E2E7292964D94C14B8F08000056E0022042118310B98C42D8A1E2A017DAE110D4A09A403DFBFE7D5BF4D9C313E3BF961E3F0F0DBAFAF16D1D529756EF7BF8BB1F967FC57CB8EEC659FEBB7E0414004D6A221E6A8881E2A8786F20420B5B6E34F12B59225F0A83AF8691DD5C8695B16B7E51AF6ED5E049FD7C63C8D0F26952F4D7E9D4B1F9E69CC1217CBD30828C09B480E5691E611F6EEFC7E3C27D5D25829085829295A46667B30648DA8DF0325E1DF3C249B4B6353CF8F5B690000B8A3232BBB0898CED254DB272CE2877AC8A080805BF0EBF9A901E7DD4BAC998D225E3BB5F0C8E1640416BBA1C5A9835039CFE78FCDFA765DE73CCDC36A5E838EFB2B543AF8100A4E85FCDE2013ECB84C52D2F55076BB8CCC6F6218EDF2F9969259F9E90EA415EDC219DBA2FC96C6CEA7EC78BBCE20E08813CB2EF16AEDBED854860C538BFCD95F3CEFAF8946E48C38479F3ED33F19DBD48942A4F3C009908BDE2F99ACDCCE6E803F6A5D173C4393BAE7A5C239C6C95777460C7428128D483562EEBBF9BA3DB7F5951CF4EEE3FF0ED9F0D446F2352FEF5782BCDB77333670F7A71D8FE2DAAA79792867A92C135B5EEDF889ECE68325CBFD17F13AB07E54DC81B96EE7037A7AE98A5869144860E453AE95ED49357F400428D9813FCD77F5E6D4C31DF0B03DDDFB74100A599A6DD74BDFF52F6BF6CBDE0E65F4EF32E2A933C3EA6AA9B54B6CF5F69F2667B1135AF7BF67C8D08E192800565D92B0741E46A17F76753AEDEBFA949AB6ADC2FD3CF22164619CA2116C793337AB322569E44A44DF63CF41E0493E722305268D47D8BA334CEFF89EB911B14A7D41E54E8A17E5423BD98B28EE9CEA4A3672BAD3D7AEFB2DFA1DACAFC2280F1587915A1E9DEDF4C764F6A2E4ECD4BFB0000F260081E72A37EFBE9D728FAFCF5C28DC27AFF2DC2512CD93D0FF0BD838A6E17D31C4F1903C6C5EA0E84FB76B820E243FB365F6F83D88A6F5E5969526BE0F76DCDAAE3067DE31157AF3F7233E69E198D986AEC2016D83A4F7FA612123E8C43EF7092FE3C7B24248EDB71EC7F1F57E3B7EFC2B6FE27C9E9F8495B72A06B97F546CC136F6EED154614D35A0D7A60C35F3B836C806DCDA88420000EC31025A300CF9FAE4832C11F36923ADA4479FB7EBB7F4CE75E55FBFBB312EC53313BDDB346B3CBC7DF7C9AD52E97124C0DC88F2B057ECE3BB4CDD010085338400840E8C4210B41884001D460002D6126542DD0AB9FCFD9CECBCD266540EB25E489A938DD17FBBE38E9F674F77B7C3DFF8D33D2849763425D6D0ABF48406F691E2C423E9F1F4473F69E085BC69DA0DF30F9EF9AE3B0A4588B5436DD19F88083CFB41A59FF6AC72E0E8E118CDDB214BAB8C78698F6D6E5AB6CFBBABEFCF691E890DEF50EF19AE9D53DD3124BCF852BDAFC36047C346499BA9C7D4A91A4B6ADF3856B43B9EA38021C476F4D0BAE3D5592400D0A7B2DC2EDE53A5E03528F7C4A1265F85FB7546AC29DAD300EB39C59F1E46F542277227A1D5E5A3B026B6CF2548747DF7EBDB330E4F4C3899D1D73B13DF86E9080078000621803404001031110E5AF6CDD7DD63D04DFE5DDCD05D5B2AC9969D4EAAFE8F8EEC042EFB4EAE11441122288A28C063003862B4C3F83F9B60207A51D8DB6F1F914BD039F121E862BCF1B30AD3DCDAB8B10CCDB0C11492C5F0E68D1FF8402DFFFB455FBF4D266CA6BBD6649522CD5C6EB37FD768B5189ADCB57CC4023127DBDC8E93F0AB5DE47C8679F9DD20080D8FD6A99B8476F8F4E3EFE4CB2021795B6B2E7E5FE7BD7D30513051DADA20D4F043BD0EAAFCA8721E9B91611100AEE31B1BD6C2DC7262CA4AE28656FB20288EFBF84EACA19D35BAF95C366EE3BBF39B958084C8085DAB6F579010842D97EA9F52C00037F1769DFD96477BAA7199283A3E416764E6863A08BE94B53D4B491C15A6D47BCAE46D35407AE0BF60335B00412151F24B5B86DEC6DCEB67432351BD99F9B1AB1971184842F94A82E257376AFB59E9546C62903D06C8490B1B95BE4E6D595BE780EE9617578A948D33E09FD3BA2462E4F85FBC0A51E3463839688400019782C7542020B4BCFBFBF60200BC0684D34034317EFF3E8F0F1EFF1EEF1EAF57BBC1025AF775DBC3E153D2DB1B630194410310C62180C006355740D658C1740F671DE99B1982925838BD348B55C27EED489F8A29F52CB3A3C2B77C488EFF263B896A2CFFACB3F6EA0A7C9CCE864F0CE1D6D3DCDC87C697370E3148073EC48DF9FCEA093F06D4AD7DCCA3F9772CA652479AB7AD0933619223F31EC1BA9F93A30994B92233F24D053B90B70347C264353C0408C44D891D548A6E63930B70565CD1BB96D9B94EEB6698A1F1613E2AB9D1929FF9D0DD6A635182F07A71929033CB7536B918A4020003EDB3655EBA9D7EFF0746FC5E3DC941FDEC0100C21DE020270DD564F5FF77DCA039FC67A778EBD7EB9BC3EFCFE12D8E0BF85DE04210A03E330FB551FA282B43BC2BF387820A7870872AE2F517B07A1B65E91146B5CD38DED80AAA625BAAE7665311ED354BC800000164D33CD447E39458FC454F85E59C46A1D1F4262C36F8C4040B4138805E99B1C548010B8A5217A9BCB6000030765CAE85E4B7DD7F531DB7A73A7235B8F8A3F6EE0D6C24F5FF8E7732BABEA12B7EB4F0E17C47F6FBF5F674BF950D8578F01CE6629E8CD7242D5159E827C9CF0B499CE473DA8518AC5BB503AAF2E3539B956B6FDD1F98EBA992C77CB722F0EE162201397C12917E916545E3580405A4BE7E712308BF9C5530366C70FC36F79178B326CF90EC0ED1992F87C40231F20042ED3C5ACDE4B9F5B6840000351FCEEB17EFD30D12471709EC4B1D3B3BFC4A8ABC8713AB72E44DD27C34C3B2B43E21085E800020EAD71F795BC642EC2DE316BE351FDDB1B88C3BF2D7ADBB40107048197A27BC631BF1D33AB73338E22D1298020FFC8C6AED8ED39155437175A60F54EF68286329416F96551EB04B41F9F4561E9C0D2CD7F7FB7FA9CC6588C927CC5D1EED501EE4EB69C973F8FAB26CA001080572E9EB1E0AC2611570267612E16056D71FCAB1F4DC354A5E5A02E643C390D942329A54ECFD27297E6A2775705471D4FCE675DEE475621FFC90EF9B33B62777E78B94277688244BD813E2869682C35F4E2010BC00819EEE4E33E385435AE8DF570CD2376BF1466633158BCDC94FCE79228203C98DAA81DC17EEC5D0F3C705549B7A5F30D0FA7B45CFB25059F3FF8BB9229C28484DBD2FEB00"
    game_data = extract_bz2(h)

    state = GameState(game_data)

    a = []
    state.next_round()

    while state.get_next_event():
        state.process_event()
        a.append(state.dump(readable=True))

    with open("log2.json", "w") as f:
        json.dump(a, f, indent=2)
